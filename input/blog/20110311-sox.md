title: Обработка звука скриптами
date: 2011-03-11 10:56
labels: blog, tech, sox, sound processing, обработка звука
author: umonkey
---
На днях я научился нормально обрабатывать звук скриптами (с помощью [sox][]),
что экономит довольно много времени при оформлении записей [прямых
эфиров](/live/) в виде [подкастов](/podcast/).  В этой заметке описан
полученный опыт.


## Суть проблемы

Исходный материал для подкаста снимает робот прямо с эфира, в том виде, в
котором его слышат обычные слушатели: это двухканальный MP3 файл с битрейтом
128кбит продолжительностью чуть более двух часов.  Этот файл уже пригоден для
выкладывания в виде подкаста, однако у него есть несколько недостатков:

- фоновый шум, который неизбежно возникает при общении через скайп;
- паузы, которые у нас пока постоянно возникают в прямых эфирах;
- слишком большой объём: 128к/стерео для речи — слишком много.


## Решение

Для обработки звука в автоматическом режиме существует программа [sox][],
которая умеет очень много всего, делает это быстрее и без участия человека.

Для удаления шума нужно сначала получить его характеристики, проанализировав
фрагмент записанной тишины продолжительностью 5-10 секунд.  Начинать эфир с
такой паузы или заканчивать ею было бы странно, мы постоянно забывали бы это
делать, к тому же эту тишину потом надо было бы как-то выделить и обработать. 
Решение довольно простое: если техническое оснащение участников не меняется,
характиристики шума будут всегда одинаковыми, поэтому можно один раз записать
фрагмент тишины и использовать его.  Для удаления тишины используется команда:

    sox source.wav cleaned.wav noisered noise-sample.noise-profile 0.3

Где noise-sample.noise-profile — это профиль шума, который вычисляется из
отрезка тишины командой:

    sox silence.wav noiseprof noise-sample.noise-profile

После удаления шума становится возможным обнаружение пауз, их можно вырезать. 
Для того, чтобы сократить паузы (сигнал с уровнем менее -50dB, подбирается
экспериментально) до 500мс, используется такая команда:

    sox cleaned.wav trimmed.wav silence -l 1 0.2 -50d -1 0.2 -50d

Ну и кодирование полученного файла, очищенного от шума и пауз, в моно MP3
64кбита выполняется так:

    lame -m m -B 64 --resample 44100 trimmed.wav sosonews-xx.mp3


## Результат

Обработка двухчасовой записи в Audacity занимала не меньше получаса: каждая
операция занимает по 5-10 минут, в течение этого времени нельзя никуда отойти,
иначе процесс затянется ещё больше.  Ещё Audacity может упасть и всё придётся
начинать сначала, а сохранение промежуточного бэкапа — это ещё несколько минут.

Обработка того же файла скриптом на двухъядерном настольном компьютере занимает
примерно 10 минут.  На нетбуке Asus EEE PC 1005 это занимает около часа, а на
нетбуке Asus EEE PC 701, на котором работает «Тоже мне радио», это буде ещё
дольше, однако всё это происходит где-то на сервере, когда ведущие уже спят, что
всех устраивает.


## Вывод

Слава роботам!

[sox]: http://sox.sourceforge.net
